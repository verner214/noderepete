<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link rel="stylesheet" href="own.css" type="text/css">
    <meta charset="utf-8" />
    <title></title>
</head>
<style>
ul li {
    margin-bottom: 0px;
}
</style>
<body>
    <h1>noderepete</h1>
    <h1><a href="/list.html">list.html</a></h1>
    <h2><a href="/new.html">new.html</a></h2>
    <h2><a href="/practise.html">practise.html</a></h2>

    <ul id="ul_debug">
    </ul>
    <label>area1</label><input id="area1" type="text" />
    <input type="button" value="lista area2" onclick="newQA();"/>
    <input type="button" value="JSON to iframe" onclick="showJSON();"/>
    <input type="button" value="Images to iframe" onclick="showIMG();"/>

    <div id="divJSON">
        <ul id="ulJSON"></ul>
    </div>
     <div id="mydiv"></div>
    <script src="jquery-1.11.2.js"></script>
    <script src="own.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#ul_debug").append("<span>ready </span>");
            var area1 = getParameterByName("area1");
            document.getElementById('area1').value = area1; 
            
            var filter = "";
            if (area1.length > 0) {
                filter = "$filter=hide%20ne%20'on'%20and%20area1%20eq%20'" + area1 + "'";
                filter += "&";
                fetchPhotoList(filter);
            }
        });
        var newQA = function () {
            var area1 = document.getElementById('area1').value;
            if (area1.length > 0) {
                window.location = 'index.html?area1=' + area1;
            }
        }

        var makeIframe = function (html) {
            var iframe = document.createElement('iframe');
            var html = "<body>" + html + "</body>";
            document.body.appendChild(iframe);
            iframe.contentWindow.document.open();
            iframe.contentWindow.document.write(html);
            iframe.contentWindow.document.close();        
        }
        var showJSON = function () {
            getJSON("", function(data) {
                $("#mydiv").text(JSON.stringify(data));
var escaped = $("<div>").text(JSON.stringify(data)).html();
                makeIframe("<pre>" + escaped + "</pre>");
            }, function(msg) {
                $("#ul_debug").append("<span>" + msg + "</span>");
            });
        }
        var showIMG = function () {
            
        }
//        function getJSON(filter, processJSON, progress) {


        var fetchPhotoList = function (filter) {
            $.support.cors = true;
            //signaturdelen (st=2015 fram till slutet) är skapat mha att gå till adressen /sas. koden finns i server.js.
            //jQuery.support.cors = true;
            $.ajax({//tableSAS:st=2015-03-29T18%3A35%3A25Z&se=2015-04-05T18%3A55%3A25Z&sp=r&sv=2014-02-14&tn=photos&sig=7t9DkALrw9QLsG4B%2BPUFodyDJHFCpvbwZsEfYoSuHpI%3D
                url: "https://portalvhdsgfh152bhy290k.table.core.windows.net/tblrepete?" + filter + 
                "st=2017-02-08T20%3A34%3A21Z&se=2036-02-14T08%3A54%3A21Z&sp=r&sv=2014-02-14&tn=tblrepete&sig=HMFUBRLCbQbegxPB3X%2FC5O2%2FbbKe2P%2Fp9GNShPvIRvw%3D",
                type: 'GET',
                success: function (data) {
					$("#ul_debug").append("<span>success</span>");
                    data = data.value;
                    var area1 = document.getElementById('area1').value;
                    var dic = {};
                    var arr = [];
                    for (var i = 0; i < data.length; i++) {//i olapp finns img-kod att hämta
                        var area2 = data[i].area2;
                        var cmt = (data[i].comments !== undefined && data[i].comments !== null && data[i].comments.length > 0) ? 1 : 0;
                        if (dic[area2] === undefined) {
                            var obj = {};
                            obj.cnt = 1;
                            obj.cntCmnt = cmt;
                            dic[area2] = obj;
                            arr.push(area2);
                        } else {
                            dic[area2].cnt += 1;
                            dic[area2].cntCmnt += cmt;
                        }                        
                    }
                    arr.sort();
                    for (var r = 0; r < arr.length; r++) {
                        $("#ulJSON").append("<li><a href='list.html?area1=" + area1 + "&area2=" + arr[r] + "'>" + 
                            arr[r] + "-" + dic[arr[r]].cnt + "</a>" + 
                            "<span style='color: red'>" + (dic[arr[r]].cntCmnt > 0 ? dic[arr[r]].cntCmnt : "") + "</span>" +
                            "</li>");                        
                    }
                },
                beforeSend: function (xhr) {
					$("#ul_debug").append("<span>beforeSend </span>");
                    xhr.setRequestHeader('Accept', 'application/json;odata=nometadata');
                },
                error: function (rcvData) {
                    alert(JSON.stringify(rcvData));
                    console.log(rcvData);
                }
            });
        };
    </script>
    
    <p style="margin-top: 100px"><a href="/sas">Generate new shared signature för storage account och table tblrepete</a></p>
</body>
</html>
